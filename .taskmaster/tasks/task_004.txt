# Task ID: 4
# Title: Reflection 노드 구현
# Status: pending
# Dependencies: 1
# Priority: high
# Description: 실행 결과를 평가하고 다음 단계를 결정하는 Reflection 노드를 구현합니다.
# Details:
1. 결과 평가 로직 구현
2. 성공/실패 판단 메커니즘 설계
3. 다음 단계 결정 로직 구현
4. 반복 또는 종료 조건 처리

```python
# Reflection 노드 구현
def reflection(state: AgentState) -> dict:
    """실행 결과를 평가하고 다음 단계를 결정하는 노드"""
    # 프롬프트 구성
    prompt = f"""
    현재 상황: {state['context']}
    계획: {state['plan']}
    실행한 도구: {state['selected_tool']}
    도구 입력: {state['tool_input']}
    도구 출력: {state['tool_output']}
    작업 이력: {state['history']}
    
    1. 실행 결과를 평가하세요.
    2. 목표를 달성했는지 판단하세요.
    3. 다음 단계를 결정하세요: 'continue' 또는 'complete'
    4. 실패한 경우 원인을 분석하고 개선 방안을 제시하세요.
    """
    
    # LLM 호출
    response = llm.invoke(prompt)
    
    # 응답 파싱
    reflection = parse_reflection(response)
    next_step = parse_next_step(response)
    
    # 상태 업데이트
    state['reflection'] = reflection
    
    # 다음 단계 결정
    if next_step == 'complete':
        return {"next": "end"}
    else:
        # 반복 횟수 확인
        if len(state['history']) >= MAX_ITERATIONS:
            return {"next": "end"}
        else:
            return {"next": "reasoning"}
```

# Test Strategy:
1. 다양한 결과 시나리오에 대한 평가 정확성 테스트
2. 성공/실패 판단 메커니즘의 일관성 검증
3. 다음 단계 결정 로직의 적절성 평가
4. 최대 반복 횟수 제한 준수 테스트
5. 실패 원인 분석 품질 평가

# Subtasks:
## 1. 결과 평가 프롬프트 설계 및 최적화 [pending]
### Dependencies: None
### Description: Reflection 노드에서 사용할 결과 평가 프롬프트를 설계하고 최적화합니다.
### Details:
1. LLM이 실행 결과를 정확히 평가할 수 있는 프롬프트 템플릿 설계
2. 목표 달성 여부를 명확히 판단할 수 있는 지시문 포함
3. 다양한 상황에 대응할 수 있는 프롬프트 구조화
4. 프롬프트 변형에 따른 성능 비교 및 최적화
5. 프롬프트 길이와 복잡성 간의 균형 조정
6. 예시 및 가이드라인 추가를 통한 LLM 응답 품질 향상

## 2. 성공/실패 판단 메커니즘 구현 [pending]
### Dependencies: 4.1
### Description: LLM 응답을 분석하여 작업의 성공 또는 실패를 판단하는 메커니즘을 구현합니다.
### Details:
1. LLM 응답에서 성공/실패 판단 정보를 추출하는 파서 구현
2. 명확한 성공/실패 기준 정의 및 구현
3. 애매한 응답 처리를 위한 휴리스틱 개발
4. 실패 원인 분석 및 분류 로직 구현
5. 성공/실패 판단 결과를 상태에 저장하는 로직 구현
6. 판단 신뢰도 점수 계산 메커니즘 추가

## 3. 다음 단계 결정 로직 및 종료 조건 처리 구현 [pending]
### Dependencies: 4.2
### Description: 작업 진행 상태에 따라 다음 단계를 결정하고 종료 조건을 처리하는 로직을 구현합니다.
### Details:
1. LLM 응답에서 다음 단계 정보('continue' 또는 'complete')를 추출하는 로직 구현
2. 최대 반복 횟수(MAX_ITERATIONS) 초과 시 종료 처리 로직 구현
3. 성공/실패 판단 결과에 따른 다음 단계 결정 알고리즘 개발
4. 반복 실행 시 이전 시도와의 중복 방지 메커니즘 구현
5. 무한 루프 방지를 위한 안전장치 추가
6. 다음 노드 선택 로직과 상태 전이 구현

## 4. 응답 파싱 및 상태 전이 로직 구현 [pending]
### Dependencies: 4.1, 4.2, 4.3
### Description: LLM 응답을 구조화된 형태로 파싱하고 에이전트 상태를 업데이트하는 로직을 구현합니다.
### Details:
1. parse_reflection() 함수 구현으로 LLM 응답에서 평가 결과 추출
2. parse_next_step() 함수 구현으로 다음 단계 결정 정보 추출
3. 구조화된 형식으로 응답을 파싱하는 정규식 또는 패턴 매칭 로직 개발
4. 파싱된 정보를 AgentState에 업데이트하는 로직 구현
5. 파싱 실패 시 기본값 처리 및 에러 핸들링 추가
6. 상태 업데이트 후 다음 노드로의 전이 로직 최적화

